---
title: "R Notebook"
output: html_notebook
---
Line graphs that match section 2: TX_NEW and HTS_TST_POST, testing all the way through PreP, include value labels, quarter on the y axis, jsut the indicator values, a line chart with all the vlaues labeled for the last year

```{r setup}
library(tidyverse)
library(patchwork)
library(dplyr)
pick <- function(condition){function(d) d %>% filter_(condition)}
```


2a
```{r}
indicators_2a <- c("HTS_TST_POS", "TX_NEW")

measure_trends_2a <- qcheck %>% filter(disagg == "KP", results!=0, indicator %in% indicators_2a) %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results)) %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% pivot_longer(cols = HTS_TST_POS:TX_NEW, names_to = "indicator", values_to = "results") %>% na.omit()

measure_trends_2a %>% ggplot2::ggplot(aes(x = fyq, y = results, group = indicator)) + geom_line(aes(color = indicator)) + si_style()
```

2b
```{r}
indicators_2b <- c("TX_CURR","TX_NEW", "TX_NET_NEW")

measure_trends_2b <- qcheck %>% filter(disagg == "KP", results!=0, indicator %in% indicators_2b) %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results)) %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% pivot_longer(TX_NEW:TX_NET_NEW, names_to = "indicator", values_to = "results") %>% na.omit()

ggplot(measure_trends_2b, aes(x = fyq, y = results)) + geom_col(data = pick(~indicator == "TX_NEW"), aes(fill = indicator), width = 0.45, position = position_nudge(x = -0.225)) + geom_col(data = pick(~indicator == "TX_NET_NEW"), aes(fill = indicator), width = 0.45, position = position_nudge(x = 0.225)) + geom_line(data = pick(~indicator == "TX_CURR"), (aes(group = 1))) + si_style()
```

2c: need to add vlc and vls percentages d = vlc n = vls
```{r}
indicators_2c <- c("TX_PVLS_N", "TX_PVLS_D", "TX_CURR_Lag2")

measure_trends_2c<- qcheck %>% filter(disagg == "KP", results!=0, indicator %in% indicators_2c) %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results))  %>% 
  pivot_wider(values_from = sum.results, names_from = indicator) %>%
  mutate(vls = TX_PVLS_N/TX_PVLS_D,
         vlc = TX_PVLS_D/TX_CURR_Lag2) %>%
  select(fyq, TX_PVLS_N, TX_PVLS_D, vlc, vls) %>%
  pivot_longer(cols = c("TX_PVLS_D","vlc","TX_PVLS_N","vls"), names_to = "indicator", values_to = "results")

ggplot(measure_trends_2c, aes(x = fyq, y = results)) + geom_col(data = pick(~indicator == "TX_PVLS_D"), aes(fill = indicator), width = 0.45, position = position_nudge(x = -0.225)) + geom_col(data = pick(~indicator == "TX_PVLS_N"), aes(fill = indicator), width = 0.45, position = position_nudge(x = 0.225))#aes(y = results, fill = indicator))#+ geom_label(position = position_stack(vjust = 0.9), aes(label = percent(ach, accuracy = 0.1))) + si_style()
```

2d
```{r}
indicators_2d <- c("HTS_TST","HTS_TST_POS")

measure_trends_2d <- qcheck %>% filter(disagg == "KP", results!=0, indicator %in% indicators_2d) %>%
  group_by(fyq, indicator, keypop) %>%
  summarise(sum.results=sum(results)) %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% 
  mutate(positivity = HTS_TST_POS/HTS_TST) %>% na.omit()

measure_trends_2d %>% ggplot2::ggplot(aes(x = fyq, y = positivity, group = keypop)) + geom_line(aes(color = keypop)) + si_style()
```

2e
```{r}
coeff <- .00001
indicators_2e <- c("HTS_TST","HTS_TST_POS")

measure_trends_2e<- qcheck %>% filter(disagg == "KP", results!=0, indicator %in% indicators_2e) %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results))  %>% 
  pivot_wider(values_from = sum.results, names_from = indicator) %>%
  mutate(positivity = HTS_TST_POS/HTS_TST)

e1 <- ggplot(measure_trends_2e, aes(x = fyq)) + geom_col(aes(y = HTS_TST_POS))
e2 <- ggplot(measure_trends_2e, aes(x = fyq)) + geom_line(aes(y = positivity, group = 1))
e1 + e2

ggplot(measure_trends_2e, aes(x = fyq)) + geom_col(aes(y = HTS_TST_POS)) + geom_line(aes(x = fyq, y = positivity, group = 1), size = 2) + geom_point(aes(y = positivity)) + scale_y_continuous(name = "HTS_TST_POS", sec.axis = sec_axis(~.*coeff, name = "HTS Positivity")) + si_style() 
```

2e2
```{r}
indicators_2e2 <- c("HTS_TST","HTS_TST_POS")

measure_trends_2e2 <- qcheck %>% filter(disagg == "KP", results!=0, indicator %in% indicators_2e) %>%
  group_by(fyq, indicator, keypop) %>%
  summarise(sum.results=sum(results))  %>% 
  pivot_wider(values_from = sum.results, names_from = indicator) %>%
  mutate(positivity = HTS_TST_POS/HTS_TST)

ggplot(measure_trends_2e2, aes(x = fyq, y = HTS_TST_POS, group = keypop)) + geom_line(aes(color = keypop)) + geom_area(aes(fill = keypop)) + geom_label(position = position_stack(vjust = 0.9), aes(label = percent(positivity, accuracy = 0.1)))
```

2f
```{r}
indicators_2f <- c("PrEP_NEW", "PrEP_CT")

measure_trends_2f <- qcheck %>% filter(disagg == "KP", results!=0, indicator %in% indicators_2f) %>%
  group_by(fy, fyq, indicator) %>%
  summarise(sum.results=sum(results)) %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% 
  group_by(fy) %>%
  mutate(fytd = cumsum(PrEP_NEW))

ggplot(measure_trends_2f, aes(x = fyq)) + geom_col(aes(x = fyq, y = fytd, fill = "FY to date")) + geom_col(aes(x = fyq, y = PrEP_NEW, fill = "PrEP_NEW"), width = 0.75)
```
