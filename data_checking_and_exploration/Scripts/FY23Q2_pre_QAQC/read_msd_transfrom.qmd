---
title: "read_msd"
author: "Bourke Betz"
format: html
editor: visual
---

Identify the name of the latest PSNU x IM MER Structured Data Set

```{r}

file <- glamr::return_latest(folderpath =  "../../Data/", pattern = "PSNU_IM_FY2")

file2 <- glamr::return_latest(folderpath =  "../../Data/", pattern = "PSNU_IM_FY1") 


file_name <- str_extract(file, "(?<=Data\\/).+(?=\\.rds)") 
file_name2 <- str_extract(file2, "(?<=Data\\/).+(?=\\.rds)") 
```

![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAaCAYAAADFTB7LAAAAa0lEQVR42u3OywnAIBBAwcXSUoCW5D11xDoNCBGNv0MOecJOBSOi1OZMsJ4dvFxEJ1OQnMxBarIKEpNNkJbsBknJYZCSnAYJyVVQziNig7/nZkFEbhTE5HpBVO4dxOXKIDL3BLG5BJ1T6rsbMfep2CaMN00AAAAASUVORK5CYII= "Run Current Chunk")

Read MSD

```{r}
mer_df <- gophr::read_psd(file, save_rds = TRUE, remove_txt = FALSE)
mer_df2 <- gophr::read_psd(file2, save_rds = TRUE, remove_txt = FALSE) %>% 
  filter(fiscal_year>=2019)
```

transform and exclude Ukraine

```{r}


table(mer_df$indicator)

indicator_list <- c("KP_PREV",  "HTS_SELF", "HTS_TST", "HTS_TST_NEG", "PrEP_NEW", "PrEP_CT", "PrEP_CURR", "HTS_TST_POS",
                    "TX_NEW", "TX_CURR", "TX_PVLS", "TX_PVLS_D", "TX_PVLS_N", "TX_CURR_Lag1", "TX_CURR_Lag2", "TX_ML", "TX_NET_NEW")

df_pre <- mer_df %>%  
  rbind(mer_df2) %>%
  mutate(indicator = 
           recode(indicator, "TX_PVLS" = paste0(indicator,"_",numeratordenom)),
                  funding_agency = recode(funding_agency, "HHS/CDC" = "CDC")) %>%
  filter(indicator %in% indicator_list,
                                     country != "Ukraine"
         ) %>% 
  mutate(indicator = factor(indicator, levels = indicator_list)) %>% 
  arrange(indicator) %>% 
  glimpse()

df <- df_pre |> 
    filter(str_detect(standardizeddisaggregate, "KeyPop|Total") == TRUE) |> 
  glimpse()


```

```{r}
check <- df %>% 
  filter(standardizeddisaggregate != "KeyPop/Status") %>%
  mutate(
        cumulative = coalesce(cumulative, 0),
         targets = coalesce(targets, 0),
         fy = fiscal_year,
         partner = prime_partner_name,
         disagg = str_extract(standardizeddisaggregate, "Total|KeyPop|Age|Pregnant"),
         disagg = recode(disagg, "KeyPop" = "KP",
                         "Age" = "Age/Sex",
                         "Pregnant" = "PregnantOrBreastfeeding"),
         tx_ml_reason = case_when(indicator=="TX_ML" ~ str_extract(otherdisaggregate, "(?<=Outcome\\s-\\s).+")),
         keypop = str_extract(otherdisaggregate, "FSW|MSM|TG|PWID|People\\sin\\sprisons"),
         keypop = recode(keypop, "People in prisons" = "Prisoners")) %>%
  select(operatingunit, country, snu1, psnu, partner, mech_code, mech_name, indicator, funding_agency, numeratordenom, disagg, standardizeddisaggregate, tx_ml_reason, keypop, fy, targets, cumulative) %>%
  mutate(indicator = factor(indicator, levels = indicator_list)) %>% arrange(indicator) 
```

```{r}

qcheck <- df %>% filter(
                  fiscal_year >= 2022, #cumulative and targets
                  # str_detect(standardizeddisaggregate, "KeyPop|Total") == TRUE
                  ) %>%
  mutate(fy = fiscal_year,
         partner = prime_partner_name,
         disagg = str_extract(standardizeddisaggregate, 
                              "Total|KeyPop|Age|Pregnant"),
         disagg = recode(disagg, "KeyPop" = "KP",
                         "Age" = "Age/Sex",
                         "Pregnant" = "PregnantOrBreastfeeding"),
         keypop = str_extract(otherdisaggregate, "FSW|MSM|TG|PWID|People\\sin\\sprisons"),
         keypop = recode(keypop, "People in prisons" = "Prisoners"),
         kp_prev_status = case_when(standardizeddisaggregate == "KeyPop/Status" ~ 
                                      str_extract(categoryoptioncomboname, 
                                                  "(?<=\\,\\s).+$"))
         ) %>% 
  select(operatingunit, country, snu1, psnu, partner, mech_code, mech_name, indicator, funding_agency, numeratordenom, disagg, standardizeddisaggregate, otherdisaggregate, keypop, kp_prev_status, ageasentered, sex, fy, qtr1, qtr2, qtr3, qtr4) %>%
  mutate(indicator = factor(indicator, levels = indicator_list)) %>% arrange(indicator) %>%
  pivot_longer(qtr1:qtr4, names_to = "qtr", values_to = "results" ) %>%
  mutate(results = coalesce(results, 0),
         qtr = str_replace(qtr, "qtr","Q"),
         fyq = paste0("FY",str_extract(fy, "..$"), " ", qtr))


modality <- mer_df %>% filter(
  # str_detect(standardizeddisaggregate, "KeyPop|Total") == FALSE,
                          str_detect(indicator, "HTS_TST") == TRUE) %>%
  pivot_longer(qtr1:qtr4, names_to = "qtr", values_to = "results" ) %>%
  mutate(results = coalesce(results, 0),
         qtr = str_replace(qtr, "qtr","Q"),
         fy = fiscal_year,
         fyq = paste0("FY",str_extract(fy, "..$"), " ", qtr),
         age = trendscoarse) %>%
  select(operatingunit, country, snu1, psnu, prime_partner_name, mech_code, mech_name, indicator, funding_agency, numeratordenom, standardizeddisaggregate, modality, fy, fyq, results, age, ageasentered, sex) %>%
  glimpse()

```

![](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAaCAYAAADFTB7LAAAAa0lEQVR42u3OywnAIBBAwcXSUoCW5D11xDoNCBGNv0MOecJOBSOi1OZMsJ4dvFxEJ1OQnMxBarIKEpNNkJbsBknJYZCSnAYJyVVQziNig7/nZkFEbhTE5HpBVO4dxOXKIDL3BLG5BJ1T6rsbMfep2CaMN00AAAAASUVORK5CYII= "Run Current Chunk")

```{r}
mmd <- mer_df %>% filter(str_detect(indicator,"TX_CURR(?!_Lag)"),
                     str_detect(standardizeddisaggregate, "ARVDispense|Total")) %>%
  mutate(cumulative = coalesce(cumulative, 0),
         targets = coalesce(targets, 0),
         partner = prime_partner_name,
         fy = fiscal_year,
         arv = str_extract(otherdisaggregate, "(?<=-\\s).+")) %>%
  select(operatingunit, country, snu1, psnu, partner, mech_code, mech_name, indicator, funding_agency, numeratordenom, standardizeddisaggregate, arv, otherdisaggregate, fy, targets, cumulative) %>%
  glimpse()
```

```{r}
rm(mer_df, df)

table(check$funding_agency)
```
