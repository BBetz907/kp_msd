---
title: "Data Checking Prep"
author: "Aditi Arunmozhi"
format: html
editor: visual
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Code

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

```{r setup}
library(tidyverse)
library(patchwork)
library(dplyr)
library(glitr)
library(scales)
pick <- function(condition){function(d) d %>% filter_(condition)}
```

### MER Cascades by FY

Filters:

IM = 81764Â  and 81759 (Malawi)

USAID, PEPFAR (Thailand)

```{r warning=FALSE}
pos <-  c("HTS_TST_POS", "TX_NEW", "TX_CURR", "TX_PVLS_D", "TX_PVLS_N")
neg <-  c("KP_PREV","HTS_TST", "HTS_TST_NEG", "HTS_SELF", "PrEP_NEW", "PrEP_CT", "PrEP_CURR")
mal_im <- c("81764","81759")
thai_agency <- c("USAID","PEPFAR")


  
#Malawi: Prevention Cascade, FY
cascade_mal_prev_1 <- check %>% filter(fy < 2023, disagg == "KP", country == "Malawi", mech_code %in% mal_im, indicator %in% neg) %>%
group_by(fy, indicator) %>%
summarise(sum.cum=sum(cumulative), sum.targets=sum(targets), .groups = 'drop') %>%
  mutate(ach = sum.cum/sum.targets) %>% 
  ggplot2::ggplot(aes(x = indicator, y = sum.cum, fill = factor(fy)))

cascade_mal_prev_1 + geom_col(aes(y = sum.targets, color = "Targets", fill = "Targets")) + geom_col(aes(y=sum.cum, color = "Cumulative", fill = "Cumulative"), width = 0.75) + geom_label(position = position_stack(vjust = 0.9), aes(label = percent(ach, accuracy = 1, color = "Achievement", fill="Achievement")), fill = "#ee636e") + si_style_xyline() + scale_color_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + scale_fill_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + labs(title = "Prevention cascade Malawi", subtitle = mal_im) + labs(title = "Malawi Prevention Cascade, IM=81764,81759") + facet_wrap(~ fy)

cascade_mal_prev_1 + geom_col(aes(y = sum.targets, color = "Targets", fill = "Targets")) + geom_col(aes(y=sum.cum, color = "Cumulative", fill = "Cumulative"), width = 0.75) +
  geom_label(position = position_stack(vjust = 0.9), aes(label = sum.cum)) + si_style_xyline() + 
  scale_color_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + 
  scale_fill_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + 
  labs(title = "Prevention cascade Malawi, IM=81764,81759", subtitle = mal_im) + facet_wrap(~ fy)

#Malawi: Prevention Cascade, by FYQ
cascade_mal_prev_q <- qcheck %>% filter(fy == 2022, disagg == "KP", country == "Malawi", mech_code %in% mal_im, indicator %in% neg) %>%
group_by(fyq, indicator) %>% 
summarise(sum.results=sum(results), .groups = 'drop') %>%
  ggplot2::ggplot(aes(x = indicator, y = sum.results, fill = factor(fyq)))

cascade_mal_prev_q + 
  geom_col(aes(y=sum.results, color = "Cumulative", fill = "Cumulative"), width = 0.75) + 
  geom_text(position = position_stack(vjust = 0.3), aes(label = sum.results), color = "#ffffff") +
  si_style_xyline() + scale_color_manual(name = "", values = c("Cumulative" = denim)) + scale_fill_manual(name = "", values = c("Cumulative" = denim)) + labs(title = "Prevention cascade Malawi", subtitle = mal_im) + 
  labs(title = "Malawi Prevention Cascade, IM=81764,81759") + facet_wrap(~ fyq)

#Malawi: Positive Cascade
cascade_mal_pos_1 <- check %>% filter(fy <2023, disagg == "KP", country == "Malawi", mech_code %in% mal_im, indicator %in% pos) %>%
group_by(fy, indicator) %>%
summarise(sum.cum=sum(cumulative), sum.targets=sum(targets), .groups = 'drop') %>%
  mutate(ach = sum.cum/sum.targets) %>%
  ggplot2::ggplot(aes(x = indicator, y = sum.cum, fill = factor(fy))) 

cascade_mal_pos_1 + geom_col(aes(y = sum.targets, color = "Targets", fill = "Targets")) + geom_col(aes(y=sum.cum, color = "Cumulative", fill = "Cumulative"), width = 0.75) + geom_label(position = position_stack(vjust = 0.9), aes(label = percent(ach, accuracy = 1, color = "Achievement", fill="Achievement")), fill = "#ee636e") + si_style_xyline() + scale_color_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + scale_fill_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + labs(title = "Malawi Positive Cascade, IM=81764,81759") + facet_grid(fy ~ c("1"))

#Thailand: Prevention Cascade
cascade_thai_prev_1 <- check %>% filter(fy == 2022, disagg == "KP", country == "Thailand",  funding_agency == "CDC", indicator %in% neg) %>%
group_by(indicator) %>%
summarise(sum.cum=sum(cumulative), sum.targets=sum(targets), .groups = 'drop') %>%
  mutate(ach = sum.cum/sum.targets) %>%
  ggplot2::ggplot(aes(x = indicator, y = sum.cum))


cascade_thai_prev_1 + geom_col(aes(y = sum.targets, color = "Targets", fill = "Targets")) + geom_col(aes(y=sum.cum, color = "Cumulative", fill = "Cumulative"), width = 0.75) + geom_label(position = position_stack(vjust = 0.9), aes(label = percent(ach, accuracy = 1, color = "Achievement", fill="Achievement")), fill = "#ee636e") + si_style_xyline() + scale_color_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + scale_fill_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e"))   + labs(title = "CDC Thailand Prevention Cascade")

#Thailand: Positive Cascade
cascade_thai_pos_1 <- check %>% filter(fy == 2022, disagg == "KP", country == "Thailand",  funding_agency == "USAID", indicator %in% pos) %>%
group_by(indicator) %>%
summarise(sum.cum=sum(cumulative), sum.targets=sum(targets), .groups = 'drop') %>%
  mutate(ach = sum.cum/sum.targets) %>%
  ggplot2::ggplot(aes(x = indicator, y = sum.cum))

cascade_thai_pos_1 + geom_col(aes(y = sum.targets, color = "Targets", fill = "Targets")) + geom_col(aes(y=sum.cum, color = "Cumulative", fill = "Cumulative"), width = 0.75) + geom_label(position = position_stack(vjust = 0.9), aes(label = percent(ach, accuracy = 1, color = "Achievement", fill="Achievement")), fill = "#ee636e") + si_style_xyline() + scale_color_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + scale_fill_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e"))   + labs(title = "USAID Thailand Positive Cascade")
```

### MER Cascades Comparison

Filters:

By KP: FSW, MSM, TG (both)

```{r warning=FALSE}

kp_comp <- c("FSW","MSM","TG")

#Malawi: Prevention Cascade
cascade_mal_prev_2 <- check %>% filter(fy == 2022, disagg == "KP", country == "Malawi", indicator %in% neg, keypop %in% kp_comp) %>%
group_by(indicator, keypop) %>%
summarise(sum.cum=sum(cumulative), sum.targets=sum(targets), .groups = 'drop') %>%
  mutate(ach = sum.cum/sum.targets) %>%
  ggplot2::ggplot(aes(x = indicator, y = sum.cum))

cascade_mal_prev_2 + geom_col(aes(y = sum.targets, color = "Targets", fill = "Targets")) + geom_col(aes(y=sum.cum, color = "Cumulative", fill = "Cumulative"), width = 0.75) + geom_label(position = position_stack(vjust = 0.3), aes(label = sum.cum), fill = "#ee636e") + si_style_xyline() + scale_color_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + scale_fill_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + facet_wrap(~keypop) + labs(title = "Malawi Prevention Cascade")

#Malawi: Positive Cascade
cascade_mal_pos_2 <- check %>% filter(fy == 2022, disagg == "KP", country == "Malawi", indicator %in% pos, keypop %in% kp_comp) %>%
group_by(indicator, keypop) %>%
summarise(sum.cum=sum(cumulative), sum.targets=sum(targets), .groups = 'drop') %>%
  mutate(ach = sum.cum/sum.targets) %>%
  ggplot2::ggplot(aes(x = indicator, y = sum.cum))

cascade_mal_pos_2 + geom_col(aes(y = sum.targets, color = "Targets", fill = "Targets")) + geom_col(aes(y=sum.cum, color = "Cumulative", fill = "Cumulative"), width = 0.75) + geom_label(position = position_stack(vjust = 0.3), aes(label = sum.cum), fill = "#ee636e") + si_style_xyline() + scale_color_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + scale_fill_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + facet_wrap(~keypop)

#Thailand: Prevention Cascade
cascade_thai_prev_2 <- check %>% filter(fy == 2022, disagg == "KP", country == "Thailand", indicator %in% neg, keypop %in% kp_comp) %>%
group_by(fy, indicator, keypop) %>%
summarise(sum.cum=sum(cumulative), sum.targets=sum(targets), .groups = 'drop') %>%
  mutate(ach = sum.cum/sum.targets) %>%
  ggplot2::ggplot(aes(x = indicator, y = sum.cum, fill = factor(fy)))

cascade_thai_prev_2 + geom_col(aes(y = sum.targets, color = "Targets", fill = "Targets")) + geom_col(aes(y=sum.cum, color = "Cumulative", fill = "Cumulative"), width = 0.75) + geom_label(position = position_stack(vjust = 0.9), aes(label = percent(ach, accuracy = 1, color = "Achievement", fill="Achievement")), fill = "#ee636e") + si_style_xyline() + scale_color_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + scale_fill_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + facet_wrap(~keypop)


#NEED TO ADD titles to figures

#Malawi: Positive Cascade
cascade_thai_pos_2 <- check %>% filter(fy == 2022, disagg == "KP", country == "Thailand", indicator %in% pos, keypop %in% kp_comp) %>%
group_by(fy, indicator, keypop) %>%
summarise(sum.cum=sum(cumulative), sum.targets=sum(targets), .groups = 'drop') %>%
  mutate(ach = sum.cum/sum.targets) %>%
  ggplot2::ggplot(aes(x = indicator, y = sum.cum, fill = factor(fy)))

cascade_thai_pos_2 + geom_col(aes(y = sum.targets, color = "Targets", fill = "Targets")) + geom_col(aes(y=sum.cum, color = "Cumulative", fill = "Cumulative"), width = 0.75) + geom_label(position = position_stack(vjust = 0.9), aes(label = percent(ach, accuracy = 1, color = "Achievement", fill="Achievement")), fill = "#ee636e") + si_style_xyline() + scale_color_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + scale_fill_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + facet_wrap(~keypop)
```

By IM (Malawi) 81764, 81759

```{r warning=FALSE}
#Malawi: Prevention Cascade
cascade_mal_prev_3 <- check %>% filter(fy == 2022, disagg == "KP", country == "Malawi", mech_code %in% mal_im, indicator %in% neg) %>%
group_by(fy, indicator, mech_code) %>%
summarise(sum.cum=sum(cumulative), sum.targets=sum(targets), .groups = 'drop') %>%
  mutate(ach = sum.cum/sum.targets) %>%
  ggplot2::ggplot(aes(x = indicator, y = sum.cum, fill = factor(fy)))

cascade_mal_prev_3 + geom_col(aes(y = sum.targets, color = "Targets", fill = "Targets")) + geom_col(aes(y=sum.cum, color = "Cumulative", fill = "Cumulative"), width = 0.75) + geom_label(position = position_stack(vjust = 0.9), aes(label = percent(ach, accuracy = 1, color = "Achievement", fill="Achievement")), fill = "#ee636e") + si_style_xyline() + scale_color_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + scale_fill_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + facet_wrap(~mech_code)

#Malawi: Positive Cascade
cascade_mal_pos_3 <- check %>% filter(fy == 2022, disagg == "KP", country == "Malawi", mech_code %in% mal_im, indicator %in% pos) %>%
group_by(fy, indicator, mech_code) %>%
summarise(sum.cum=sum(cumulative), sum.targets=sum(targets), .groups = 'drop') %>%
  mutate(ach = sum.cum/sum.targets) %>%
  ggplot2::ggplot(aes(x = indicator, y = sum.cum, fill = factor(fy)))

cascade_mal_pos_3 + geom_col(aes(y = sum.targets, color = "Targets", fill = "Targets")) + geom_col(aes(y=sum.cum, color = "Cumulative", fill = "Cumulative"), width = 0.75) + geom_label(position = position_stack(vjust = 0.9), aes(label = percent(ach, accuracy = 1, color = "Achievement", fill="Achievement")), fill = "#ee636e") + si_style_xyline() + scale_color_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + scale_fill_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + facet_wrap(~mech_code)

```

By agency (Thailand)

```{r warning=FALSE}
#Thailand: Prevention Cascade
cascade_thai_prev_3 <- check %>% filter(fy == 2022, disagg == "KP", country == "Thailand", indicator %in% neg) %>%
group_by(indicator, funding_agency) %>%
summarise(sum.cum=sum(cumulative), sum.targets=sum(targets), .groups = 'drop') %>%
  mutate(ach = sum.cum/sum.targets) %>%
  ggplot2::ggplot(aes(x = indicator, y = sum.cum, fill = factor(fy)))

cascade_thai_prev_3 + geom_col(aes(y = sum.targets, color = "Targets", fill = "Targets")) + geom_col(aes(y=sum.cum, color = "Cumulative", fill = "Cumulative"), width = 0.75) + geom_label(position = position_stack(vjust = 0.9), aes(label = percent(ach, accuracy = 1, color = "Achievement", fill="Achievement")), fill = "#ee636e") + si_style_xyline() + scale_color_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + scale_fill_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + facet_wrap(~funding_agency)

#Thailand: Positive Cascade
cascade_thai_pos_3 <- check %>% filter(fy == 2022, disagg == "KP", country == "Thailand", indicator %in% pos) %>%
group_by(indicator, funding_agency) %>%
summarise(sum.cum=sum(cumulative), sum.targets=sum(targets), .groups = 'drop') %>%
  mutate(ach = sum.cum/sum.targets) %>%
  ggplot2::ggplot(aes(x = indicator, y = sum.cum, fill = factor(fy)))

cascade_thai_pos_3 + geom_col(aes(y = sum.targets, color = "Targets", fill = "Targets")) + geom_col(aes(y=sum.cum, color = "Cumulative", fill = "Cumulative"), width = 0.75) + geom_label(position = position_stack(vjust = 0.9), aes(label = percent(ach, accuracy = 1, color = "Achievement", fill="Achievement")), fill = "#ee636e") + si_style_xyline() + scale_color_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + scale_fill_manual(name = "", values = c("Targets" = grey10k, "Cumulative" = denim, "Achievement" = "#ee636e")) + facet_wrap(~funding_agency)
```

1a. Indicator Comparisons: PrEP_CT, HTS_TST_POS in Cameroon, Uganda By KP, funding Agency

###should only be 1 indicator in each view, unlike 1b

```{r warning=FALSE}

indicator_1a <- c("PrEP_CT","HTS_TST_POS")

#Cameroon

#By KP
measure_trends_cam_kp <- check %>% filter(fy == 2022, disagg == "KP", country == "Cameroon", indicator =="PrEP_CT") %>%
  group_by(keypop, indicator) %>%
  summarise(sum.cumulative=sum(cumulative), .groups = "drop")

measure_trends_cam_kp %>% ggplot(aes(keypop, sum.cumulative)) + 
  geom_col(aes(y = sum.cumulative, fill = keypop)) +  
  geom_text(position = position_stack(vjust = 0.3), aes(label = sum.cumulative)) + 
  si_style_xyline()

#By Funding Agency
measure_trends_cam_fa <- check %>% filter(fy == 2022, disagg == "KP", country == "Cameroon", indicator== "HTS_TST_POS") %>%
  group_by(funding_agency) %>%
  summarise(sum.cumulative=sum(cumulative), .groups = "drop")

ggplot(measure_trends_cam_fa, aes(funding_agency, sum.cumulative)) + geom_col(aes(y = sum.cumulative, fill = funding_agency)) + si_style_xyline() +   geom_text(position = position_stack(vjust = 0.3), aes(label = sum.cumulative)) 

#Uganda


###########################################
#doesn't run, please correct. visualize only 1 indicator at a time.
###########################################

#By KP
measure_trends_ug_kp <- check %>% filter(fy == 2022, disagg == "KP", country == "Uganda", indicator %in% indicator_1a) %>%
  group_by(indicator, keypop) %>%
  summarise(sum.cumulative=sum(cumulative), .groups = "drop")

ggplot(measure_trends_ug_kp, aes(x = indicator)) + geom_col(aes(y = sum.cumulative, fill = indicator)) + si_style_xyline() +  + facet_wrap(~keypop)

#By Funding Agency
measure_trends_ug_fa <- check %>% filter(fy == 2022, disagg == "KP", country == "Uganda", indicator %in% indicator_1a) %>%
  group_by(indicator, funding_agency) %>%
  summarise(sum.cumulative=sum(cumulative), .groups = "drop")

ggplot(measure_trends_ug_fa, aes(x = indicator)) + geom_col(aes(y = sum.cumulative, fill = indicator)) + si_style_xyline() + scale_color_manual(name = "", values = c("PrEP_CT" = grey10k, "HTS_TST_POS" = denim)) + scale_fill_manual(name = "", values = c("PrEP_CT" = grey10k, "HTS_TST_POS" = denim)) + facet_wrap(~funding_agency)
```

1b. Indicator Trends: HTS_TST, HTS_TST_POS in Mozambique, Uganda

```{r warning=FALSE}
indicator_1b <- c("HTS_TST","HTS_TST_POS")

#Uganda
measure_trends_ug_kp_b <- qcheck %>% filter(country == "Uganda", disagg == "KP", results!=0, indicator %in% indicator_1b, funding_agency == "USAID") %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% pivot_longer(cols = HTS_TST:HTS_TST_POS, names_to = "indicator", values_to = "results") %>% na.omit()

measure_trends_ug_kp_b %>% ggplot2::ggplot(aes(x = fyq, y = results, group = indicator)) + geom_line(aes(color = indicator)) +   geom_text(position = position_stack(), aes(label = results)) + si_style_xyline()

#Mozambique, PEPFAR
measure_trends_ug_kp_b <- qcheck %>% filter(country == "Mozambique", disagg == "KP", results!=0, indicator %in% indicator_1b) %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% pivot_longer(cols = HTS_TST:HTS_TST_POS, names_to = "indicator", values_to = "results") %>% na.omit()

measure_trends_ug_kp_b %>% ggplot2::ggplot(aes(x = fyq, y = results, group = indicator)) + geom_line(aes(color = indicator)) + geom_text(position = position_stack(), aes(label = results)) + si_style_xyline()
```

1c. Indicator Trend Comparison: By KP, By agency

#more indicators than necessary are in the view. With a few exceptions it's one at a time. Since we're checking the data, we really need to see values, even if they aren't aesthetically pleasing.

```{r warning=FALSE}
#Uganda

#By KP
measure_trends_ug_kp_c <- qcheck %>% filter(country == "Uganda", disagg == "KP", results!=0, indicator %in% indicator_1b) %>%
  group_by(fyq, indicator, keypop) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% pivot_longer(cols = HTS_TST:HTS_TST_POS, names_to = "indicator", values_to = "results") %>% na.omit()

measure_trends_ug_kp_c %>% ggplot2::ggplot(aes(x = fyq, y = results, group = indicator)) + geom_line(aes(color = indicator)) + si_style_xyline() + facet_wrap(~keypop) + geom_text(position = position_stack(), aes(label = results))

#By Funding Agency
measure_trends_ug_kp_c <- qcheck %>% filter(country == "Uganda", disagg == "KP", results!=0, indicator== "HTS_TST") %>%
  group_by(fyq, funding_agency) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results) %>% pivot_longer(cols = HTS_TST)values_to = "results") %>% na.omit()

measure_trends_ug_kp_c %>% ggplot2::ggplot(aes(x = fyq, y = results, group = indicator)) + geom_line(aes(color = indicator)) + si_style_xyline() + facet_wrap(~funding_agency) + geom_text(position = position_stack(), aes(label = results))

#Mozambique

#By KP
measure_trends_ug_kp_c <- qcheck %>% filter(country == "Mozambique", disagg == "KP", results!=0, indicator %in% indicator_1b) %>%
  group_by(fyq, indicator, keypop) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% pivot_longer(cols = HTS_TST:HTS_TST_POS, names_to = "indicator", values_to = "results") %>% na.omit()

measure_trends_ug_kp_c %>% ggplot2::ggplot(aes(x = fyq, y = results, group = indicator)) + geom_line(aes(color = indicator)) + si_style_xyline() + facet_wrap(~keypop) + geom_text(position = position_stack(), aes(label = results))

#By Funding Agency
measure_trends_ug_kp_c <- qcheck %>% filter(country == "Mozambique", disagg == "KP", results!=0, indicator %in% indicator_1b) %>%
  group_by(fyq, indicator, funding_agency) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% pivot_longer(cols = HTS_TST:HTS_TST_POS, names_to = "indicator", values_to = "results") %>% na.omit()

measure_trends_ug_kp_c %>% ggplot2::ggplot(aes(x = fyq, y = results, group = indicator)) + geom_line(aes(color = indicator)) + si_style_xyline() + facet_wrap(~funding_agency)+ geom_text(position = position_stack(), aes(label = results))


```

2a. Testing and Linkage Trends

```{r warning=FALSE}
indicators_2a <- c("HTS_TST_POS", "TX_NEW")
agency_2a <- c("PEPFAR","USAID")

#Vietnam
measure_trends_viet_2a <- qcheck %>% filter(country == "Vietnam", disagg == "KP", results!=0, indicator %in% indicators_2a, funding_agency %in% agency_2a, partner == "Family Health International") %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% pivot_longer(cols = HTS_TST_POS:TX_NEW, names_to = "indicator", values_to = "results") %>% na.omit()

measure_trends_viet_2a %>% ggplot2::ggplot(aes(x = fyq, y = results, group = indicator)) + geom_line(aes(color = indicator)) + si_style_xyline() + ylim(0,1000) + geom_text(aes(label = results))

#Laos

#MSM
measure_trends_laos_2a <- qcheck %>% filter(country == "Laos", disagg == "KP", results!=0, indicator %in% indicators_2a, funding_agency == "USAID", keypop == "MSM") %>%
  group_by(fyq, indicator, keypop) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% pivot_longer(cols = HTS_TST_POS:TX_NEW, names_to = "indicator", values_to = "results") %>% na.omit()

measure_trends_laos_2a %>% ggplot2::ggplot(aes(x = fyq, y = results, group = indicator)) + geom_line(aes(color = indicator)) + si_style_xyline() + ylim(0,175) + geom_text(aes(label = results))
```

2b. TX Trends

```{r warning=FALSE}
indicators_2b <- c("TX_CURR","TX_NEW", "TX_NET_NEW")
#Vietnam

measure_trends_viet_2b <- qcheck %>% filter(country == "Vietnam", disagg == "KP", results!=0, indicator %in% indicators_2b, funding_agency %in% agency_2a, partner == "Family Health International") %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% pivot_longer(TX_NEW:TX_NET_NEW, names_to = "indicator", values_to = "results") %>% na.omit()

ggplot(measure_trends_viet_2b, aes(x = fyq, y = results)) + geom_col(data = pick(~indicator == "TX_NEW"), aes(fill = indicator), width = 0.45, position = position_nudge(x = -0.225)) + geom_col(data = pick(~indicator == "TX_NET_NEW"), aes(fill = indicator), width = 0.45, position = position_nudge(x = 0.225)) + geom_line(data = pick(~indicator == "TX_CURR"), (aes(group = 1))) + si_style_xyline()+ scale_color_manual(name = "", values = c("TX_NET_NEW" = grey10k, "TX_NEW" = denim)) + scale_fill_manual(name = "", values = c("TX_NET_NEW" = grey10k, "TX_NEW" = denim))

measure_trends_viet_2b

#Laos

#MSM Only
measure_trends_laos_2b_msm <- qcheck %>% filter(country == "Laos", disagg == "KP", results!=0, indicator %in% indicators_2b, funding_agency == "USAID", keypop == "MSM") %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% pivot_longer(TX_NEW:TX_NET_NEW, names_to = "indicator", values_to = "results") %>% na.omit()

ggplot(measure_trends_laos_2b_msm, aes(x = fyq, y = results)) + geom_col(data = pick(~indicator == "TX_NEW"), aes(fill = indicator), width = 0.45, position = position_nudge(x = -0.225)) + geom_col(data = pick(~indicator == "TX_NET_NEW"), aes(fill = indicator), width = 0.45, position = position_nudge(x = 0.225)) + geom_line(data = pick(~indicator == "TX_CURR"), (aes(group = 1))) + si_style_xyline()+ scale_color_manual(name = "", values = c("TX_NET_NEW" = grey10k, "TX_NEW" = denim)) + scale_fill_manual(name = "", values = c("TX_NET_NEW" = grey10k, "TX_NEW" = denim))

measure_trends_laos_2b_msm

#USAID All People
### Here we actually need to filter to Totals. Otherwise KP get counted twice.
qcheck
measure_trends_laos_2b_all <- qcheck %>% filter(country == "Laos", results!=0, indicator %in% indicators_2b, funding_agency == "USAID", disagg == "Total") %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% pivot_longer(TX_NEW:TX_NET_NEW, names_to = "indicator", values_to = "results") %>% na.omit()


ggplot(measure_trends_laos_2b_all, aes(x = fyq, y = results)) + geom_col(data = pick(~indicator == "TX_NEW"), aes(fill = indicator), width = 0.45, position = position_nudge(x = -0.225)) + geom_col(data = pick(~indicator == "TX_NET_NEW"), aes(fill = indicator), width = 0.45, position = position_nudge(x = 0.225)) + geom_line(data = pick(~indicator == "TX_CURR"), (aes(group = 1))) + si_style_xyline()+ scale_color_manual(name = "", values = c("TX_NET_NEW" = grey10k, "TX_NEW" = denim)) + scale_fill_manual(name = "", values = c("TX_NET_NEW" = grey10k, "TX_NEW" = denim))

measure_trends_laos_2b_all
```

2c. VL Trends

```{r}
indicators_2c <- c("TX_PVLS_N", "TX_PVLS_D", "TX_CURR_Lag2")

#Kenya

measure_trends_ken_2c<- qcheck %>% filter(country == "Kenya", disagg == "KP", results!=0, indicator %in% indicators_2c, funding_agency %in% agency_2a, keypop == "FSW") %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop")  %>% 
  pivot_wider(values_from = sum.results, names_from = indicator) %>%
  mutate(vls = TX_PVLS_N/TX_PVLS_D,
         vlc = TX_PVLS_D/TX_CURR_Lag2) %>%
  select(fyq, TX_PVLS_N, TX_PVLS_D, vlc, vls) %>%
  pivot_longer(cols = c("TX_PVLS_D","vlc","TX_PVLS_N","vls"), names_to = "indicator", values_to = "results")


ken_c1 <- ggplot(measure_trends_ken_2c, aes(x = fyq, y = results)) + geom_col(data = pick(~indicator == "TX_PVLS_D"), aes(fill = indicator), width = 0.45, position = position_nudge(x = -0.225)) + geom_col(data = pick(~indicator == "TX_PVLS_N"), aes(fill = indicator), width = 0.45, position = position_nudge(x = 0.225)) + si_style_xyline() + scale_color_manual(name = "", values = c("TX_PVLS_N" = grey10k, "TX_PVLS_D" = denim)) + scale_fill_manual(name = "", values = c("TX_PVLS_N" = grey10k, "TX_PVLS_D" = denim))

ken_c2 <- ggplot(measure_trends_ken_2c, aes(x = fyq, y = results)) + geom_line(data = pick(~indicator == "vlc"), aes(fill = indicator, color = indicator), group = 1) + geom_line(data = pick(~indicator == "vls"), aes(fill = indicator, color = indicator), group = 1) + si_style_xyline()

measure_trends_ken_2c

ken_c1 + ken_c2

#Mozambique

measure_trends_moz_2c<- qcheck %>% filter(country == "Mozambique", disagg == "KP", results!=0, indicator %in% indicators_2c, mech_code == "70212") %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop")  %>% 
  pivot_wider(values_from = sum.results, names_from = indicator) %>%
  mutate(vls = TX_PVLS_N/TX_PVLS_D,
         vlc = TX_PVLS_D/TX_CURR_Lag2) %>%
  select(fyq, TX_PVLS_N, TX_PVLS_D, vlc, vls) %>%
  pivot_longer(cols = c("TX_PVLS_D","vlc","TX_PVLS_N","vls"), names_to = "indicator", values_to = "results") %>% print()

moz_c1 <- ggplot(measure_trends_moz_2c, aes(x = fyq, y = results)) + geom_col(data = pick(~indicator == "TX_PVLS_D"), aes(fill = indicator), width = 0.45, position = position_nudge(x = -0.225)) + geom_col(data = pick(~indicator == "TX_PVLS_N"), aes(fill = indicator), width = 0.45, position = position_nudge(x = 0.225)) + si_style_xyline() + scale_color_manual(name = "", values = c("TX_PVLS_N" = grey10k, "TX_PVLS_D" = denim)) + scale_fill_manual(name = "", values = c("TX_PVLS_N" = grey10k, "TX_PVLS_D" = denim))

moz_c2 <- ggplot(measure_trends_moz_2c, aes(x = fyq, y = results)) + geom_line(data = pick(~indicator == "vlc"), aes(fill = indicator, color = indicator), group = 1) + geom_line(data = pick(~indicator == "vls"), aes(fill = indicator, color = indicator), group = 1) + si_style_xyline()

measure_trends_moz_2c
moz_c1 + moz_c2

### another round
measure_trends_moz_2c2<- qcheck %>% filter(country == "Mozambique", disagg == "KP", results!=0, indicator %in% indicators_2c, funding_agency == "CDC") %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop")  %>% 
  pivot_wider(values_from = sum.results, names_from = indicator) %>%
  mutate(vls = TX_PVLS_N/TX_PVLS_D,
         vlc = TX_PVLS_D/TX_CURR_Lag2) %>%
  select(fyq, TX_PVLS_N, TX_PVLS_D, vlc, vls) %>%
  pivot_longer(cols = c("TX_PVLS_D","vlc","TX_PVLS_N","vls"), names_to = "indicator", values_to = "results") %>% print()

moz_c12 <- ggplot(measure_trends_moz_2c2, aes(x = fyq, y = results)) + geom_col(data = pick(~indicator == "TX_PVLS_D"), aes(fill = indicator), width = 0.45, position = position_nudge(x = -0.225)) + geom_col(data = pick(~indicator == "TX_PVLS_N"), aes(fill = indicator), width = 0.45, position = position_nudge(x = 0.225)) + si_style_xyline() + scale_color_manual(name = "", values = c("TX_PVLS_N" = grey10k, "TX_PVLS_D" = denim)) + scale_fill_manual(name = "", values = c("TX_PVLS_N" = grey10k, "TX_PVLS_D" = denim))

moz_c22 <- ggplot(measure_trends_moz_2c2, aes(x = fyq, y = results)) + geom_line(data = pick(~indicator == "vlc"), aes(fill = indicator, color = indicator), group = 1) + geom_line(data = pick(~indicator == "vls"), aes(fill = indicator, color = indicator), group = 1) + si_style_xyline()

moz_c12 + moz_c22
```

2d. Positivity Trends

```{r warning=FALSE}
indicators_2d <- c("HTS_TST","HTS_TST_POS")

#Jamaica: KP

measure_trends_kp_2d <- qcheck %>% filter(country == "Jamaica", disagg == "KP", results!=0, indicator %in% indicators_2d) %>%
  group_by(fyq, indicator, keypop) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% 
  mutate(positivity = HTS_TST_POS/HTS_TST) %>% na.omit()

measure_trends_kp_2d %>% ggplot2::ggplot(aes(x = fyq, y = positivity, group = keypop)) + geom_line(aes(color = keypop)) +  scale_y_continuous(labels = scales::percent) + si_style_xyline() + scale_color_manual(name = "", values = c("FSW" = "#005e7a", "MSM" = "#f28965", "Prisoners" = "#990d2e", "PWID" = "#fbcc50", "TG" = "#7ecfc0", "All People" = "#a7a9ac")) + scale_fill_manual(name = "", values = c("FSW" = "#005e7a", "MSM" = "#f28965", "Prisoners" = "#990d2e", "PWID" = "#fbcc50", "TG" = "#7ecfc0", "All People" = "#a7a9ac")) + geom_text(aes(label = percent(positivity, accuracy = 0.1)))

#Jamaica: All people, all partners

measure_trends_2d_all <- qcheck %>% filter(country == "Jamaica", results!=0, indicator %in% indicators_2d, disagg == "Total") %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>% 
  mutate(positivity = HTS_TST_POS/HTS_TST) %>% na.omit()

measure_trends_2d_all %>% ggplot2::ggplot(aes(x = fyq, y = positivity, group = 1)) + geom_line() +  scale_y_continuous(labels = scales::percent) + si_style_xyline() + scale_color_manual(name = "", values = c("FSW" = "#005e7a", "MSM" = "#f28965", "Prisoners" = "#990d2e", "PWID" = "#fbcc50", "TG" = "#7ecfc0", "All People" = "#a7a9ac")) + scale_fill_manual(name = "", values = c("FSW" = "#005e7a", "MSM" = "#f28965", "Prisoners" = "#990d2e", "PWID" = "#fbcc50", "TG" = "#7ecfc0", "All People" = "#a7a9ac")) + geom_text(aes(label = percent(positivity, accuracy = 0.1)))
```

2e. Positivity + Yield Trends

```{r}
coeff <- .00001
indicators_2e <- c("HTS_TST","HTS_TST_POS")

measure_trends_2e<- qcheck %>% filter(country == "Botswana", disagg == "KP", results!=0, indicator %in% indicators_2e) %>%
  group_by(fyq, indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop")  %>% 
  pivot_wider(values_from = sum.results, names_from = indicator) %>%
  mutate(positivity = HTS_TST_POS/HTS_TST)

e1 <- ggplot(measure_trends_2e, aes(x = fyq)) + geom_col(aes(y = HTS_TST_POS)) + si_style_xyline()
e2 <- ggplot(measure_trends_2e, aes(x = fyq)) + geom_line(aes(y = positivity, group = 1)) + si_style_xyline()
e1 + e2

#2e2
indicators_2e2 <- c("HTS_TST","HTS_TST_POS")

measure_trends_2e2 <- qcheck %>% filter(country == "India", disagg == "KP", results!=0, indicator %in% indicators_2e) %>%
  group_by(fyq, indicator, keypop) %>%
  summarise(sum.results=sum(results), .groups = "drop")  %>% 
  pivot_wider(values_from = sum.results, names_from = indicator) %>%
  mutate(positivity = HTS_TST_POS/HTS_TST)

ggplot(measure_trends_2e2, aes(x = fyq, y = HTS_TST_POS, group = keypop)) + geom_line(aes(color = keypop)) + geom_area(aes(fill = keypop)) + scale_color_manual(name = "", values = c("FSW" = "#005e7a", "MSM" = "#f28965", "Prisoners" = "#990d2e", "PWID" = "#fbcc50", "TG" = "#7ecfc0", "All People" = "#a7a9ac")) + scale_fill_manual(name = "", values = c("FSW" = "#005e7a", "MSM" = "#f28965", "Prisoners" = "#990d2e", "PWID" = "#fbcc50", "TG" = "#7ecfc0", "All People" = "#a7a9ac")) + geom_text(aes(label =HTS_TST_POS))
```

2f. PrEP Trends

```{r warning=FALSE}
indicators_2f <- c("PrEP_NEW", "PrEP_CT")
kp_2f <- c("FSW","MSM")
mech_2f <- c(70212,9811,13583)

#Indonesia
measure_trends_ind_2f <- qcheck %>% filter(country == "Indonesia", disagg == "KP", results!=0, indicator %in% indicators_2f, keypop %in% kp_2f) %>%
  group_by(fy, fyq, indicator, keypop) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>%
  group_by(fy) %>%
  mutate(fytd = cumsum(PrEP_NEW))

ggplot(measure_trends_ind_2f, aes(x = fyq)) + geom_col(aes(x = fyq, y = fytd, fill = "FY to date")) + geom_col(aes(x = fyq, y = PrEP_NEW, fill = "PrEP_NEW"), width = 0.75) + si_style_xyline() + scale_color_manual(name = "", values = c("FY to date" = grey10k, "PrEP_NEW" = denim)) + scale_fill_manual(name = "", values = c("FY to date" = grey10k, "PrEP_NEW" = denim)) + facet_wrap(~keypop)

#Mozambique
measure_trends_moz_2f <- qcheck %>% filter(country == "Mozambique", disagg == "KP", results!=0, indicator %in% indicators_2f, mech_code %in% mech_2f) %>%
  group_by(fy, fyq, indicator, mech_code) %>%
  summarise(sum.results=sum(results), .groups = "drop") %>%
  pivot_wider(values_from = sum.results, names_from = indicator) %>%
  group_by(fy) %>%
  mutate(fytd = cumsum(PrEP_NEW))


#scale is quarterly values, fy to date total gneral matches shape but not values
ggplot(measure_trends_moz_2f, aes(x = fyq)) + geom_col(aes(x = fyq, y = fytd, fill = "FY to date")) + geom_col(aes(x = fyq, y = PrEP_NEW, fill = "PrEP_NEW"), width = 0.75) + si_style_xyline() + scale_color_manual(name = "", values = c("FY to date" = grey10k, "PrEP_NEW" = denim)) + scale_fill_manual(name = "", values = c("FY to date" = grey10k, "PrEP_NEW" = denim)) + facet_wrap(~mech_code)

measure_trends_moz_2f
```

5b. VL Comparisons

```{r}
#Haiti
measure_trends_haiti_5a<- qcheck %>% filter(country == "Haiti", disagg == "KP", results!=0, indicator %in% indicators_2c, funding_agency == "USAID", fyq == "FY22 Q3", disagg == "KP") %>%
  group_by(snu1, indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop")  %>% 
  pivot_wider(values_from = sum.results, names_from = indicator) %>%
  mutate(vls = TX_PVLS_N/TX_PVLS_D,
         vlc = TX_PVLS_D/TX_CURR_Lag2) %>%
  select(snu1, vlc, vls)

ggplot(measure_trends_haiti_5a, aes(x = vlc, y = vls)) + geom_point() + si_style_xyline() + geom_text(aes(label = paste0(percent(vlc, accuracy = 1), " vlc    ", percent(vls, accuracy = 1), "vls "))) + xlim(0,1.1) + ylim(0,1.1)

#El Salvador
measure_trends_es_5a<- qcheck %>% filter(country == "El Salvador", results!=0, indicator %in% indicators_2c, fyq == "FY22 Q3", disagg == "KP") %>%
  group_by(keypop, indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop")  %>% 
  pivot_wider(values_from = sum.results, names_from = indicator) %>%
  mutate(vls = TX_PVLS_N/TX_PVLS_D,
         vlc = TX_PVLS_D/TX_CURR_Lag2) %>%
  select(keypop, vlc, vls)

ggplot(measure_trends_es_5a, aes(x = vlc, y = vls)) + geom_point() + si_style_xyline() + geom_text(aes(label = paste0(percent(vlc, accuracy = 1), " vlc    ", percent(vls, accuracy = 1), "vls "))) + xlim(0,4)
```

5a. VL by Geography

```{r}
#Zimbabwe by KP
measure_trends_zim_5a<- qcheck %>% filter(country == "Zimbabwe", disagg == "KP", results!=0, indicator %in% indicators_2c, fyq == "FY22 Q3", disagg == "KP") %>%
  group_by(indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop")  %>% 
  pivot_wider(values_from = sum.results, names_from = indicator) %>%
  mutate(vls = TX_PVLS_N/TX_PVLS_D,
         vlc = TX_PVLS_D/TX_CURR_Lag2) %>%
  select(vlc, vls, TX_PVLS_D, TX_PVLS_N, TX_CURR_Lag2)

measure_trends_zim_5a

# ggplot(measure_trends_zim_5a, aes(x = vlc, y = vls)) + geom_point(aes(keypop)) + si_style_xyline() +  geom_text(aes(label = paste0(percent(vlc, accuracy = 1), " vlc    ", percent(vls, accuracy = 1), "vls ")))

measure_trends_es_5a<- qcheck %>% filter(country == "El Salvador", disagg == "KP", results!=0, indicator %in% indicators_2c, fyq == "FY22 Q3", disagg == "KP") %>%
  group_by(psnu, indicator) %>%
  summarise(sum.results=sum(results), .groups = "drop")  %>% 
  pivot_wider(values_from = sum.results, names_from = indicator) %>%
  mutate(vls = TX_PVLS_N/TX_PVLS_D,
         vlc = TX_PVLS_D/TX_CURR_Lag2) %>%
  select(psnu, vlc, vls, TX_PVLS_D, TX_PVLS_N, TX_CURR_Lag2)

measure_trends_es_5a

```
